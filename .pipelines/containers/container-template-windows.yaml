parameters:
  name: ""
  arch: ""
  tag: ""
  ai_path: ""
  ai_path_var: ""
  ai_id: ""
  ai_id_var: ""

steps:
- task: Docker@2
  displayName: Login
  inputs:
    containerRegistry: $(ACR_SERVICE_CONNECTION)
    command: 'login'
    addPipelineData: false

- script: |
    set -e
    docker version
    echo tag: $TAG
    docker buildx create --name winbuilder --use --platform windows/amd64
    docker buildx build \
      --push \
      --platform windows/amd64  \
      -f ${{ parameters.name }}/windows.Dockerfile \
      --build-arg VERSION=windows-${{ parameters.arch }}-${{ parameters.tag }} \
      --build-arg ${{ parameters.ai_path_var }}=${{ parameters.ai_path }} \ 
      --build-arg ${{ parameters.ai_id_var }}=${{ parameters.ai_id }} \
      -t acnpublic.azurecr.io/azure-${{ parameters.name }}:windows-${{ parameters.arch }}-${{ parameters.tag }}
  name: image_build
  displayName: Image Build
  retryCountOnTaskFailure: 3

- task: Docker@2
  displayName: Logout
  inputs:
    containerRegistry: $(ACR_SERVICE_CONNECTION)
    command: 'logout'
    addPipelineData: false
